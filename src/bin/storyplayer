#!/usr/bin/env php
<?php

/**
 * storyplayer
 *         CLI tool for playing individual stories
 *
 *         Very handy for testing stories as you write them
 *
 * @author Stuart Herbert <stuart.herbert@datasift.com>
 * @copyright (c) 2012-present MediaSift Ltd.
 */

use Phix_Project\Autoloader4\PSR0_Autoloader;
use Phix_Project\Autoloader4\Autoloader_Path;

use DataSift\Stone\ConfigLib\ConfigLoader;
use DataSift\Stone\LogLib\Log;
use DataSift\Storyplayer\PlayerLib\DefaultConfig;
use DataSift\Storyplayer\PlayerLib\RuntimeConfigManager;
use DataSift\Storyplayer\PlayerLib\StoryConfigLoader;
use DataSift\Storyplayer\PlayerLib\StoryPlayer;
use DataSift\Storyplayer\PlayerLib\StoryTeller;
use DataSift\Storyplayer\StoryLib\StoryLoader;
use DataSift\Storyplayer\StoryListLib\StoryListLoader;
use DataSift\Storyplayer\UserLib\User;
use DataSift\Storyplayer\UserLib\GenericUserGenerator;
use DataSift\Storyplayer\UserLib\ConfigUserLoader;

// where are we, and our useful utilities?
define('APP_BINDIR', __DIR__);

// work out where the local source code might be
$localSrcDir = '';
$localSrcDirs = array(
	__DIR__ . '/../../src/php',
	getcwd() . '/src/php',
	getcwd() . '/php'
);
foreach ($localSrcDirs as $key => $candidateDir) {
	if (!is_dir($candidateDir)) {
		unset($localSrcDirs[$key]);
	}
}

// work out where the vendor folder might be
$vendorDir = '';
$vendorDirs = array(
	__DIR__ . '/../../vendor/php',
	getcwd() . '/vendor/php'
);
foreach ($vendorDirs as $key => $candidateDir) {
	if (is_dir($candidateDir)) {
		$vendorDir = $candidateDir;
	}
}

// load the autoloader file
if (is_dir($vendorDir)) {
	require $vendorDir . '/Phix_Project/Autoloader4/PSR0/Autoloader.php';
}
else {
	require 'Phix_Project/Autoloader4/PSR0/Autoloader.php';
}

// start autoloading
PSR0_Autoloader::startAutoloading();

// if we have a vendor folder, load from there
foreach ($vendorDirs as $vendorDir){
	Autoloader_Path::searchFirst(realpath($vendorDir));
}

// if we have a source dir, we also want to load from there
foreach ($localSrcDirs as $localSrcDir){
	Autoloader_Path::searchFirst($localSrcDir);
}

// load our list of helper functions
require 'DataSift/Storyplayer/functions.php';

function summariseStoryList($storyResults)
{
	// we need to make a pronouncement about the whole list of stories

	echo "\n";
	echo "============================================================\n";
	echo "FINAL RESULTS\n";
	echo "\n";

	foreach ($storyResults as $result)
	{
		echo $result->story->getName() . " :: " . StoryPlayer::$outcomeToText[$result->storyResult] . "\n";
	}
}

/**
 * it all happens here, baby
 *
 * @return integer status code to return to the shell
 */
function main($argv)
{

	// make sure we have enough arguments
	if (!isset($argv[2])) {
		echo "*** error: insufficient parameters\n";
		echo "*** usage: " . $argv[0] . " <environment> <story>\n";
		exit(1);
	}

	// What's our current hostname?
	$hostname = trim(`hostname`);

	// create our runtime config folder
	$runtimeConfigManager = new RuntimeConfigManager();
	$runtimeConfigManager->makeConfigDir();

	// create our initial default config
	$staticConfig = new DefaultConfig();

	// load our main config
	$configLoader = new StoryConfigLoader();
	$loadedConfig = $configLoader->loadDefaultConfig();

	// merge our default config in with our main loaded config
	$staticConfig->mergeFrom($loadedConfig);

	// load any per-user overrides
	$configLoader->loadUserConfig($staticConfig);

	// do we need to load environment-specific config?
	if (!isset($staticConfig->environments, $staticConfig->environments->$argv[1]))
	{
		// load our environment-specific config
		//
		// this will be merged in with the default config
		$configLoader->loadAdditionalConfig($staticConfig, $argv[1]);
	}

	// finally, load the runtime config, data that has been created
	// by previous runs of storyplayer
	$runtimeConfig = $configLoader->loadRuntimeConfig();

	// setup logging
	Log::init("storyplayer", $staticConfig->logger);

	// pick our environment
	$environment = $argv[1];

	// @TODO validate environment

	// create our user generator
	$userGenerator = new GenericUserGenerator();

	// create our user loader
	// it will use our user generator if no cached user is found
	$userLoader = new ConfigUserLoader($userGenerator);

	// are we loading a story, or a list of stories?
	$arg2suffix = end(explode('.', $argv[2]));
	switch($arg2suffix)
	{
		case "php":
			// we are running an individual story

			// load our story
			$story = StoryLoader::loadStory($argv[2]);

			// create something to play this story
		    $player = new StoryPlayer();
		    $teller = new StoryTeller($story);

		    // create the supporting context for this story
		    $context = $player->createContext($staticConfig, $runtimeConfig, $environment, $story);
		    $teller->setStoryContext($context);
		    $teller->setConfigLoader($configLoader);

		    // make the story happen
		    $result = $player->play($teller, $staticConfig);

		    // all done
		    break;

	    case "json":
	    	// we are running a list of stories

	    	// load the list of stories
	    	$storyList = StoryListLoader::loadList($argv[2]);

	    	// keep track of the results
	    	$results = array();

	    	// run through our list of stories
	    	foreach ($storyList->stories as $storyFile)
	    	{
				// load our story
				$story = StoryLoader::loadStory($storyFile);

				// create something to play this story
			    $player = new StoryPlayer();
			    $teller = new StoryTeller($story);

			    // create the supporting context for this story
			    $context = $player->createContext($staticConfig, $runtimeConfig, $environment, $story);
			    $teller->setStoryContext($context);
			    $teller->setConfigLoader($configLoader);

			    // special case - reusable environments
			    if ($storyList->options->reuseTestEnvironment) {
			    	// we need to remember the staticConfig, as we are
			    	// probably about to override it
				    $origStaticConfig = clone $staticConfig;

			    	// story #1 - keep the test environment around
			    	if ($storyFile == $storyList->stories[0]) {
			    		// we do not override the user's preference for
			    		// the TestEnvironmentStartup

			    		// do not shutdown the TestEnvironment;
			    		// we want to re-use it in the other stories
			    		$staticConfig->phases->TestEnvironmentTeardown = false;
			    	}
			    	else if ($storyFile == end($storyList->stories)) {
			    		// do nothing - we do not want to override
			    		// the user's config file settings here
			    	}
			    	else {
			    		// we are running a story in the middle of the list
			    		//
			    		// do not re-create the test environment
			    		// do not destroy it afterwards
			    		$staticConfig->phases->TestEnvironmentSetup = false;
			    		$staticConfig->phases->testEnvironmentTeardown = false;
			    	}
			    }

			    // make the story happen
			    $results[] = $player->play($teller, $staticConfig);

			    // special case - reusable environments
			    if ($storyList->options->reuseTestEnvironment) {
				    // restore the original config
				    $staticConfig = clone $origStaticConfig;
			    }
	    	}

	    	// report on the final results
	    	summariseStoryList($results);

	    	// all done
	    	break;

	    default:
	    	// unsupported!
	}

    // write out any changed runtime config to disk
    $configLoader->saveRuntimeConfig($runtimeConfig);

    // all done
    return 0;
}

return main($argv);
